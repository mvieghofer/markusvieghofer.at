<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>How I implemented my first PHP Router</title>
  <meta name="description" content="I’ve recently started to learn PHP and created a small example project. The small project soon got bigger and bigger and I added feature after feature.">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://markusvieghofer.at/2015/08/08/how-i-implemented-my-first-php-router.html">
  <link rel="alternate" type="application/rss+xml" title="Software made in Österreich" href="http://markusvieghofer.at/feed.xml">
</head>


  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">

    <a class="site-title" href="/">Software made in Österreich</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">How I implemented my first PHP Router</h1>
    <p class="post-meta"><time datetime="2015-08-08T10:38:25+02:00" itemprop="datePublished">Aug 8, 2015</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>I’ve recently started to learn PHP and created a small example project. The small project soon got bigger and bigger and I added feature after feature.</p>

<p>The first version of the project was really messy. It was coded as you would expect if from a PHP beginner. I soon realized that this is not the way a PHP application works and so I started to split everything up and use MVC to structure the application.</p>

<p>To be as flexible as possible it is a good idea to use a router to execute controller steps according to the requested URL. Therefore I started to implemented my first and very simple router.</p>

<h1 id="simple-router">Simple Router</h1>

<p>First I edited the .htaccess file to rewrite the URL and pass it to my index.php file. If I entered the URL http://localhost/post/new the URL would have been modified in a way that it looks like this: http://localhost/index.php?url=post/new. So everything after the http://localhost/ was cut off and set to the url parameter which is then added to the end of the URL.</p>

<p>The .htaccess file I use look like the following:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>Options -MultiViews 
RewriteEngine On 
RewriteBase /public/ 
RewriteCond %<span class="o">{</span>REQUEST_FILENAME<span class="o">}</span> !-d 
RewriteCond %<span class="o">{</span>REQUEST_FILENAME<span class="o">}</span> !-f 
RewriteRule ^<span class="o">(</span>.+<span class="o">)</span><span class="nv">$ </span> index.php?url<span class="o">=</span><span class="nv">$1</span> <span class="o">[</span>QSA,L]
</code></pre>
</div>

<p>Now the url I request is passed to the index.php and can be processed.</p>

<p>To do this I wrote a little class that accomplishes this. This class originally had two public methods: (1) an <span class="code">add</span> method and (2) a <span class="code">run</span> method.</p>

<p>You could add a mapping between an url and a controller method to the router and when you are done you just had to execute the run method to start the controller. Whenever a new url was requested the router was initialized and processed the url parameter in the run method.</p>

<p>The <span class="code">add</span> method of the router class looks like the following:</p>

<div class="language-php highlighter-rouge"><pre class="highlight"><code>public function add($uri, $function) { 
    $uri = str_replace('/', '\/', $uri); 
    $this-&gt;urlMap[$uri] = $function; 
}
</code></pre>
</div>

<p>It takes an url parameter and maps it to the function passed. This can be either the name of a controller as well as the method that should be invoked separated by a # or a function.</p>

<p>Example calls for this method could look like this:</p>

<div class="language-php highlighter-rouge"><pre class="highlight"><code>$router = new Router(); 
$router-&gt;add('/home', 'HomeController#indexAction'); 
$router-&gt;add('/about', function() { 
    $controller = new AboutController(); 
    $controller-&gt;indexAction(); 
});
</code></pre>
</div>

<p>After you added the url patterns and the corresponding functions to execute the router has to actually map the incoming url to the configured urls. For doing this I’ve implemented a <span class="code">run</span> method.</p>

<p>The run method iterates over all mapped url and checks them against the incoming url. If a url matches the incoming url either the function that is mapped to the url is executed.</p>

<p>This is either a real function that just has to be called or it is a string representation of the controller and the function of the controller that should be called. In the second case the string is split so that I have the controller step and the function to call in an array.</p>

<p>I can build the path to the controller and include it to my PHP script. Then I can call the method of the controller by using the <span class="code">call_user_func_array</span> function.</p>

<p>The parameters passed to that function are extracted by the getParamsFromUrl function. This function basically compares the mapped url with the incoming url and cuts off everything from the incoming url that is also defined in the mapped url. For example, when the mapped url is <span class="code">/post/\d+</span> and the incoming url is <span class="code">/post/15</span> the extracted parameters are <span class="code">15</span>.</p>

<div class="language-php highlighter-rouge"><pre class="highlight"><code>public function run() { 
    $url = '/'; 
    if (isset($_GET['url'])) { 
        $url .= $_GET['url']; 
    } 

    foreach ($this-&gt;urlMap as $key =<span class="ni">&amp;gt;</span> $value) { 
        if (preg_match("/^$key$/", $url)) { 
            $this-&gt;mapUrl($url, $key, $value); 
        } 
    } 
} 

protected function getControllerFileName($controllerName) { 
    return APP_PATH . '/controllers/' . $controllerName . '.php'; 
} 

private function mapUrl($url, $key, $function) { 
    if (is_string($function)) { 
        // extract the params form the url and create an array 
        // from them 
        $params = $this-&gt;getParamsFromUrl($url, $key); 
        $params = $params ? array_values($params) : []; 

        // split the controller#function string at the # symbol 
        $function = explode('#', $function); 

        // include the controller and create an instance 
        require_once($this-&gt;getControllerFileName($function[0])); 
        $controller = new $function[0]; 

        // call the function of the controller and pass the params      
        call_user_func_array([$controller, $function[1]], $params); 
    } else { 
        call_user_func($function); 
    } 
} 

private function getParamsFromUrl($url, $regex) { 
    if (isset($url) <span class="ni">&amp;amp;&amp;amp;</span> isset($regex)) { 
        $regex = str_replace('\/', '/', $regex); 
        $url = explode('/', filter_var(rtrim($url, '/'), FILTER_SANITIZE_URL)); 
        $regex = explode('/', filter_var(rtrim($regex, '/'), FILTER_SANITIZE_URL)); 
        if (sizeof($url) != sizeof($regex)) { 
            return []; 
        } 
        foreach ($url as $index =<span class="ni">&amp;gt;</span> $value) { 
            if ($regex[$index] == $value) { 
                unset($url[$index]); 
            } 
        } 
        return $url; 
    } 
}
</code></pre>
</div>

<p>After implementing this function it has to be called. This is done in the index.php file right after all urls are added to the router.</p>

<div class="language-php highlighter-rouge"><pre class="highlight"><code>$router = new Router(); 
$router-&gt;add('/home', 'HomeController#indexAction'); 
$router-&gt;add('/about', function() { 
    $controller = new AboutController(); 
    $controller-&gt;indexAction(); 
}); 
$router-&gt;run();
</code></pre>
</div>

<h1 id="advanced-router">Advanced Router</h1>

<p>To be able to do more than just add urls to function mappings I’ve extended the router and added some more functionality. Instead of having just an add method I’ve added a <span class="code">get</span>, <span class="code">post</span>, <span class="code">put</span> and <span class="code">delete</span> method. Also the <span class="code">add</span> method got another parameter, an array of methods.</p>

<p>As you already guessed, the <span class="code">get</span> method executes a function if a certain url is accessed via the HTTP get method. For the <span class="code">post</span>, <span class="code">put</span> and <span class="code">delete</span> method it is similar.</p>

<p>The new <span class="code">add</span> method does basically the same thing as before, it just stores the urls and functions in a matrix where the second dimension are the HTTP methods.</p>

<div class="language-php highlighter-rouge"><pre class="highlight"><code>public function get($uri, $function) { 
    $this-&gt;add($uri, $function, ['GET']); 
} 

public function post($uri, $function) { 
    $this-&gt;add($uri, $function, ['POST']); 
} 

public function put($uri, $function) { 
    $this-&gt;add($uri, $function, ['PUT']); 
} 

public function delete($uri, $function) { 
    $this-&gt;add($uri, $function, ['DELETE']); 
} 

public function add($uri, $function, array $methods) { 
    $uri = str_replace('/', '\/', $uri); 
    if (!isset($this-&gt;urlMap[$uri]) || empty($this-&gt;urlMap[$uri])) { 
        $this-&gt;urlMap[$uri] = []; 
    } 
    foreach($methods as $method) { 
        $this-&gt;urlMap[$uri][$method] = $function; 
    } 
}
</code></pre>
</div>

<p>After this change also the <span class="code">run</span> method has to be adapted. The correct method for the current HTTP method has to be used.</p>

<div class="language-php highlighter-rouge"><pre class="highlight"><code>public function run() { 
    $method = $_SERVER['REQUEST_METHOD']; 
    $url = '/'; 
    if (isset($_GET['url'])) { 
        $url .= $_GET['url']; 
    } 
    foreach ($this-&gt;urlMap as $key =&gt; $value) { 
        if (preg_match("/^$key$/", $url) <span class="err">&amp;&amp;</span> isset($value) <span class="err">&amp;&amp;</span> isset($value[$method])) { 
            $this-&gt;mapUrl($url, $key, $value[$method]); 
        } 
    } 
}
</code></pre>
</div>

<p>After these changes were implemented the configuration of the router has to be adapted. All urls that should only be mapped for a certain HTTP method are mapped using the corresponding method. All urls that should be mapped for multiple methods are mapped using the <span class="code">add</span> method. For this case also the methods have to be passed.</p>

<div class="language-php highlighter-rouge"><pre class="highlight"><code>$router = new Router(); 
$router-&gt;get('/home', 'HomeController#getAction'); 
$router-&gt;post('/home', 'HomeController#postAction'); 
$router-&gt;add('/about', function() { 
    $controller = new AboutController(); 
    $controller-&gt;indexAction(); 
}, ['GET', 'POST', 'DELETE', 'PUT']); 
$router-&gt;run();
</code></pre>
</div>
<p> </p>

<p><span style="color: #999999;">Featured image take from https://flic.kr/p/hW31Na</span></p>


  </div>

</article>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Software made in Österreich</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Software made in Österreich</li>
          <li><a href="mailto:your-email@domain.com">your-email@domain.com</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/mvieghofer"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">mvieghofer</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/mvieghofer"><span class="icon icon--twitter"><svg viewBox="0 0 16 16"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">mvieghofer</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
